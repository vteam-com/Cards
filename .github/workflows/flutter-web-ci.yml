name: Flutter Web CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate Firebase options
      run: |
        mkdir -p lib/models/app
        if [ -n "${{ secrets.FIREBASE_OPTIONS_FILE }}" ]; then
          echo "${{ secrets.FIREBASE_OPTIONS_FILE }}" | base64 --decode > lib/models/app/firebase_options.dart
        else
          cp lib/models/app/firebase_options.example.dart lib/models/app/firebase_options.dart
        fi

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.9'
        channel: 'stable'
        
    - name: Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
          
    - name: Install dependencies
      run: flutter pub get
      
    - name: Run code formatting
      run: dart format --set-exit-if-changed .
      
    - name: Apply automatic fixes
      run: dart fix --apply
      
    - name: Analyze code
      run: flutter analyze lib test
      
    - name: Run tests
      run: flutter test --reporter=compact
      
    - name: Install fcheck
      run: dart pub global activate fcheck
      
    - name: Run fcheck analysis
      run: fcheck --svg --svgfolder --fix .
      
    - name: Upload fcheck artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fcheck-reports
        path: |
          layers.svg
          layers_folders.svg
          
    - name: Build Flutter Web
      run: flutter build web --release --dart-define=FLUTTER_WEB_CANVASKIT_URL=/canvaskit/
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flutter-web-build
        path: build/web/

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.9'
        channel: 'stable'

    - name: Restore Firebase options
      run: |
        mkdir -p lib/models/app
        if [ -n "${{ secrets.FIREBASE_OPTIONS_FILE }}" ]; then
          echo "${{ secrets.FIREBASE_OPTIONS_FILE }}" | base64 --decode > lib/models/app/firebase_options.dart
        else
          cp lib/models/app/firebase_options.example.dart lib/models/app/firebase_options.dart
        fi

    - name: Generate firebase.json for Hosting
      run: |
        cat <<'EOF' > firebase.json
        {
          "hosting": {
            "site": "vteam-cards",
            "public": "build/web",
            "ignore": [
              "firebase.json",
              "**/.*",
              "**/node_modules/**"
            ]
          }
        }
        EOF

    - name: Download web build
      uses: actions/download-artifact@v5
      with:
        name: flutter-web-build
        path: .

    - name: Deploy to Firebase Hosting (action)
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_VTEAM_CARDS }}
        channelId: live
        projectId: vteam-cards
